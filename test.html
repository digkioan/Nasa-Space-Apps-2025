<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Greece Air Map + Forecast</title>
  <!-- Tailwind from CDN for utilities in classes -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- MapLibre GL -->
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    /* Καθαρό CSS – χωρίς @apply (Tailwind @apply απαιτεί build) */
    .card{ padding:1rem; border-radius:1rem; border:1px solid #e4e4e7; background:#ffffff; }
    .btn{ padding:0.375rem 0.75rem; border-radius:0.75rem; font-size:0.875rem; border:1px solid #d4d4d8; background:#ffffff; }
    .btn-active{ background:#0a0a0a; color:#ffffff; border-color:transparent; }
  </style>
</head>
<body class="bg-zinc-50 text-zinc-900">
  <div class="max-w-6xl mx-auto p-4 space-y-4">
    <header class="flex items-center gap-3">
      <h1 class="text-xl font-semibold">Χάρτης Ποιότητας Αέρα – Ελλάδα</h1>
      <span class="text-sm text-zinc-500">Κέντρο: 38.000°, 23.730° · Zoom: 6.2</span>
    </header>

    <!-- Controls -->
    <div class="flex flex-wrap gap-2 items-center">
      <label class="text-sm">Ρύπος:</label>
      <div id="pollutant-pills" class="flex gap-2"></div>
      <button id="refresh" class="btn">Ανανέωση</button>
      <span id="oaq-count" class="text-sm text-zinc-500"></span>
    </div>

    <!-- Layout: Map + Status/Chart -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="lg:col-span-2 card">
        <div id="map" class="h-[440px] rounded-xl overflow-hidden"></div>
      </div>
      <div class="card space-y-3">
        <div class="flex items-center justify-between">
          <div class="text-sm text-zinc-500">Τώρα</div>
          <div id="aqi-chip" class="px-2 py-1 rounded-lg text-xs bg-gray-200 text-gray-700">—</div>
        </div>
        <div class="flex items-end gap-3">
          <div id="aqi-value" class="text-5xl font-bold leading-none">—</div>
          <div class="text-sm text-zinc-500 mb-1">AQI</div>
        </div>
        <div class="text-xs text-zinc-500">Ρύπος: <span id="pollutant-label">PM₂.₅</span></div>
        <div class="h-56"><canvas id="forecast" height="220"></canvas></div>
      </div>
    </div>

    <p class="text-xs text-zinc-500">Δεδομένα σταθμών: OpenAQ · Πρόγνωση: Open‑Meteo Air Quality API (72h)</p>
  </div>

  <script>
    // ------------------ Baseline config (Ελλάδα) ------------------
    var GREECE = { center: [23.73, 38.0], zoom: 6.2 }; // [lon, lat]
    var POLLUTANTS = [
      { key:'pm25', label:'PM₂.₅', unit:'µg/m³', openaq:'pm25', openmeteo:'pm25' },
      { key:'o3',   label:'O₃',    unit:'ppb',   openaq:'o3',   openmeteo:'ozone' },
      { key:'no2',  label:'NO₂',   unit:'ppb',   openaq:'no2',  openmeteo:'nitrogen_dioxide' }
    ];
    var STATE = { pollutant: 'pm25', map: null, chart: null };

    // ------------------ Helpers ------------------
    function aqiFromValue(v){ if(v==null||isNaN(v)) return null; var a=0; if(v<=12)a=Math.round((v/12)*50); else if(v<=35)a=50+Math.round(((v-12)/23)*50); else a=100+Math.round(((v-35)/65)*100); return Math.min(300,Math.max(0,a)); }
    function aqiCategory(a){ if(a==null) return {label:'—',cls:'bg-gray-200 text-gray-700'}; if(a<=50)return{label:'Καλό',cls:'bg-emerald-500 text-emerald-900'}; if(a<=100)return{label:'Μέτριο',cls:'bg-yellow-400 text-yellow-900'}; if(a<=150)return{label:'Ευαίσθ. Ομάδες',cls:'bg-orange-400 text-orange-900'}; if(a<=200)return{label:'Ανθυγιεινό',cls:'bg-red-500 text-red-50'}; if(a<=300)return{label:'Πολύ Ανθυγιεινό',cls:'bg-fuchsia-600 text-fuchsia-50'}; return{label:'Επικίνδυνο',cls:'bg-purple-800 text-purple-50'}; }

    function fetchOpenAQLatest(opts){
      var lat = opts.lat, lon = opts.lon, radius = opts.radius || 250000, parameter = opts.parameter || 'pm25';
      var url = new URL('https://api.openaq.org/v3/measurements');
      url.searchParams.set('coordinates', lat+','+lon);
      url.searchParams.set('radius', String(radius));
      url.searchParams.set('parameter', parameter);
      url.searchParams.set('limit', '500');
      url.searchParams.set('sort', 'desc');
      url.searchParams.set('order_by', 'datetime');
      return fetch(url.toString()).then(function(res){
        if(!res.ok) throw new Error('OpenAQ '+res.status);
        return res.json();
      }).then(function(data){
        var results = data && data.results ? data.results : [];
        return { type:'FeatureCollection', features: results.map(function(r){ return { type:'Feature', geometry:{ type:'Point', coordinates:[r.coordinates.longitude, r.coordinates.latitude] }, properties:r }; }) };
      });
    }

    function fetchOpenMeteo72h(lat, lon, param){
      var url = new URL('https://air-quality-api.open-meteo.com/v1/air-quality');
      url.searchParams.set('latitude', lat); url.searchParams.set('longitude', lon);
      url.searchParams.set('hourly', param); url.searchParams.set('timezone', 'auto');
      return fetch(url.toString()).then(function(r){ return r.json(); }).then(function(j){
        var times = (j && j.hourly && j.hourly.time) ? j.hourly.time.slice(0,72) : [];
        var vals = (j && j.hourly && j.hourly[param]) ? j.hourly[param].slice(0,72) : [];
        return { times: times, vals: vals };
      });
    }

    // ------------------ UI: pollutant pills ------------------
    var pills = document.getElementById('pollutant-pills');
    POLLUTANTS.forEach(function(p){ var b=document.createElement('button'); b.className='btn'+(STATE.pollutant===p.key?' btn-active':''); b.textContent=p.label; b.onclick=function(){ STATE.pollutant=p.key; renderPills(); updateAll(); }; pills.appendChild(b); });
    function renderPills(){
      Array.prototype.slice.call(pills.children).forEach(function(el,i){ el.className='btn'+(POLLUTANTS[i].key===STATE.pollutant?' btn-active':''); });
      var found = POLLUTANTS.filter(function(x){ return x.key===STATE.pollutant; })[0];
      document.getElementById('pollutant-label').textContent = found ? found.label : 'Ρύπος';
    }

    // ------------------ Map ------------------
    STATE.map = new maplibregl.Map({ container:'map', style:'https://demotiles.maplibre.org/style.json', center:GREECE.center, zoom:GREECE.zoom, attributionControl:true });
    STATE.map.addControl(new maplibregl.NavigationControl({ showCompass:false }), 'bottom-right');
    STATE.map.on('load', function(){ refreshStations(); });
    STATE.map.on('click', 'openaq-circles', function(e){
      var f = e && e.features && e.features[0] ? e.features[0] : null; if(!f) return; var p=f.properties;
      new maplibregl.Popup({ closeButton:false }).setLngLat(e.lngLat).setHTML(
        '<div style="font-weight:600;margin-bottom:4px;">'+(p.location||'Σταθμός')+'</div>'+
        '<div style="font-size:12px;color:#555;margin-bottom:4px;">'+(p.city||'')+'</div>'+
        '<div style="font-size:14px;">'+String(p.parameter).toUpperCase()+' : <b>'+Number(p.value).toFixed(1)+' '+p.unit+'</b></div>'+
        '<div style="font-size:12px;color:#666;margin-top:4px;">'+new Date(p.datetime).toLocaleString()+' · '+(p.sourceName||'OpenAQ')+'</div>'
      ).addTo(STATE.map);
    });

    function refreshStations(){
      var center = STATE.map.getCenter().toArray();
      var lon = center[0], lat = center[1];
      var found = POLLUTANTS.filter(function(p){ return p.key===STATE.pollutant; })[0];
      var openaqKey = found ? found.openaq : 'pm25';
      fetchOpenAQLatest({ lat: lat, lon: lon, parameter: openaqKey }).then(function(gjson){
        document.getElementById('oaq-count').textContent = gjson.features.length ? ('Σταθμοί: '+gjson.features.length) : '';
        if(!STATE.map.getSource('openaq')){
          STATE.map.addSource('openaq', { type:'geojson', data:gjson });
          STATE.map.addLayer({ id:'openaq-circles', type:'circle', source:'openaq', paint:{
            'circle-radius': ['interpolate',['linear'],['zoom'], 6,3, 12,7],
            'circle-color': ['interpolate',['linear'],['get','value'], 0,'#10b981', 12,'#f59e0b', 35,'#ef4444', 55,'#a21caf'],
            'circle-stroke-color':'#fff','circle-stroke-width':1,'circle-opacity':0.9 } });
        } else { STATE.map.getSource('openaq').setData(gjson); }
        // Update AQI panel from first point (rough nowcast)
        var first = (gjson.features && gjson.features[0]) ? gjson.features[0] : null;
        var v = first && first.properties ? first.properties.value : null;
        var aqi = aqiFromValue(Number(v));
        var cat = aqiCategory(aqi);
        var chip=document.getElementById('aqi-chip'); chip.className='px-2 py-1 rounded-lg text-xs '+cat.cls; chip.textContent=cat.label; document.getElementById('aqi-value').textContent = (aqi==null? '—' : aqi);
      });
    }

    document.getElementById('refresh').addEventListener('click', function(){ refreshStations(); refreshForecast(); });

    // ------------------ Forecast chart ------------------
    function refreshForecast(){
      var center = STATE.map.getCenter().toArray();
      var lon = center[0], lat = center[1];
      var found = POLLUTANTS.filter(function(p){ return p.key===STATE.pollutant; })[0];
      var param = found ? found.openmeteo : 'pm25';
      fetchOpenMeteo72h(lat, lon, param).then(function(res){
        var times = res.times;
        var vals = res.vals;
        var labels = times.map(function(t){ return new Date(t).toLocaleString([], { month:'2-digit', day:'2-digit', hour:'2-digit' }); });
        var ctx = document.getElementById('forecast').getContext('2d');
        if(STATE.chart) STATE.chart.destroy();
        var label = found ? found.label : 'Ρύπος';
        STATE.chart = new Chart(ctx, {
          type: 'line',
          data: { labels: labels, datasets: [{ label: label, data: vals, borderWidth: 2, pointRadius: 0 }] },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
        });
      });
    }

    function updateAll(){ renderPills(); refreshStations(); refreshForecast(); }
    // Boot
    updateAll();
  </script>
</body>
</html>
