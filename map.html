<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Space Apps — 3D Globe (NASA Web WorldWind)</title>
  <style>
    html, body { height:100%; margin:0; background:#000; }
    /* Fullscreen starry GIF background */
    #bg {
      position: fixed; inset: 0; z-index: -1;
      background: #000 url("stars.gif") center / cover repeat;
      image-rendering: optimizeQuality;
    }
    /* Stage holds the WorldWind canvas */
    #stage { position:absolute; inset:0 }
    #wwdCanvas { position:absolute; inset:0; width:100%; height:100%; border:0; display:block }

    /* Minimal control (start/stop rotate) */
    .panel {
      position: absolute; top: 12px; left: 12px;
      display: inline-flex; gap: 8px; align-items: center;
      background: rgba(0,0,0,.45); color:#fff; padding: 8px 10px; border-radius: 12px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; font-size: 14px;
      backdrop-filter: blur(4px);
    }
    .panel button {
      padding: 6px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.12); color: #fff; cursor: pointer;
    }
    .panel button:hover { background: rgba(255,255,255,.2); }

    /* Analog joystick */
    .joystick {
      position: absolute; left: 16px; bottom: 16px; width: 120px; height: 120px; border-radius: 50%;
      background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.15); backdrop-filter: blur(4px);
      touch-action: none; user-select: none;
    }
    .joystick .stick {
      position: absolute; left: 50%; top: 50%; width: 56px; height: 56px; margin-left: -28px; margin-top: -28px; border-radius: 50%;
      background: rgba(255,255,255,.25); border: 1px solid rgba(255,255,255,.35);
      box-shadow: 0 4px 14px rgba(0,0,0,.35);
      transition: transform 80ms ease-out;
      touch-action: none;
    }
  </style>
</head>
<body>
  <!-- Starry background (put your GIF at stars.gif) -->
  <div id="bg" aria-hidden="true"></div>

  <!-- Globe container -->
  <div id="stage">
    <canvas id="wwdCanvas"></canvas>
  </div>

  <!-- Minimal control -->
  <div class="panel">
    <span>3D Globe</span>
    <button id="toggleSpin">⏸ Stop</button>
  </div>

  <!-- On‑screen joystick -->
  <div class="joystick" id="joy"><div class="stick" id="stick"></div></div>

  <!-- NASA Web WorldWind -->
  <script src="https://files.worldwind.arc.nasa.gov/artifactory/web/0.11.0/worldwind.min.js"></script>
  <script>
    // ====== Init WorldWind native globe ======
    const canvas = document.getElementById('wwdCanvas');
    let rotating = true;         // auto-rotate ON by default
    const ROTATE_SPEED = 0.03;   // degrees per frame (~1.8°/s)

    function initWorldWind() {
      if (!window.WorldWind) { console.error('WorldWind failed to load'); return null; }
      WorldWind.configuration.baseUrl = 'https://files.worldwind.arc.nasa.gov/artifactory/web/0.11.0/';
      const wwd = new WorldWind.WorldWindow('wwdCanvas');

      // Base imagery
      wwd.addLayer(new WorldWind.BMNGOneImageLayer());
      wwd.addLayer(new WorldWind.BMNGLandsatLayer());
      // Atmosphere glow (stars are the page background GIF)
      wwd.addLayer(new WorldWind.AtmosphereLayer());

      // Start zoomed in over Greece
      wwd.navigator.lookAtLocation.latitude = 37.9838;  // Athens
      wwd.navigator.lookAtLocation.longitude = 23.7275;
      wwd.navigator.range = 9e5; // ~900 km from surface for a regional view
      wwd.redraw();

      // Auto-rotate loop
      function spin() {
        if (rotating) {
          wwd.navigator.heading = (wwd.navigator.heading + ROTATE_SPEED) % 360;
          wwd.redraw();
        }
        requestAnimationFrame(spin);
      }
      requestAnimationFrame(spin);
      return wwd;
    }

    const wwd = initWorldWind();

    // ====== UI: Start/Stop auto-rotate ======
    const btn = document.getElementById('toggleSpin');
    btn.addEventListener('click', () => {
      rotating = !rotating;
      btn.textContent = rotating ? '⏸ Stop' : '⟳ Auto-rotate';
    });

    // ====== Analog joystick to move the globe (pan) ======
    const joy = document.getElementById('joy');
    const stick = document.getElementById('stick');
    const R = 50; // radius in px for max deflection
    let active = false, joyCenter = {x:0,y:0}, vec = {x:0,y:0};

    function setStick(x, y){
      // constrain to circle of radius R
      const dx = x - joyCenter.x, dy = y - joyCenter.y;
      const len = Math.hypot(dx, dy);
      const clamped = len > R ? { x: dx * R/len, y: dy * R/len } : { x: dx, y: dy };
      stick.style.transform = `translate(${clamped.x}px, ${clamped.y}px)`;
      vec.x = clamped.x / R; // -1..1
      vec.y = clamped.y / R; // -1..1
    }

    function resetStick(){ stick.style.transform = 'translate(0,0)'; vec.x = vec.y = 0; }

    function pageToLocal(ev){ const r = joy.getBoundingClientRect(); return { x: ev.clientX - r.left - r.width/2, y: ev.clientY - r.top - r.height/2, cx: r.left + r.width/2, cy: r.top + r.height/2 }; }

    joy.addEventListener('pointerdown', ev => {
      active = true; joy.setPointerCapture(ev.pointerId);
      const p = pageToLocal(ev); joyCenter = { x: p.cx - joy.getBoundingClientRect().left, y: p.cy - joy.getBoundingClientRect().top };
      setStick(p.x + joy.getBoundingClientRect().width/2, p.y + joy.getBoundingClientRect().height/2);
      rotating = false; // pause auto-rotate while user controls
    });
    joy.addEventListener('pointermove', ev => { if (!active) return; const p = pageToLocal(ev); setStick(p.cx, p.cy); });
    joy.addEventListener('pointerup', ev => { active = false; resetStick(); });
    joy.addEventListener('pointercancel', () => { active = false; resetStick(); });

    // Apply joystick vector each frame
    const PAN_SPEED = 0.15; // degrees per second at full deflection (approx)
    let lastTs = performance.now();
    function joystickLoop(ts){
      const dt = (ts - lastTs) / 1000; lastTs = ts;
      if (wwd && (Math.abs(vec.x) > 0.01 || Math.abs(vec.y) > 0.01)){
        // Adjust longitude and latitude; invert Y so up moves north
        const lat = wwd.navigator.lookAtLocation.latitude - vec.y * PAN_SPEED * dt * 60; // scaled by 60 fps nominal
        let lon = wwd.navigator.lookAtLocation.longitude + vec.x * PAN_SPEED * dt * 60 / Math.max(0.2, Math.cos(lat*Math.PI/180));
        // Clamp latitude to avoid poles
        const clampedLat = Math.max(-85, Math.min(85, lat));
        if (lon < -180) lon += 360; else if (lon > 180) lon -= 360;
        wwd.navigator.lookAtLocation.latitude = clampedLat;
        wwd.navigator.lookAtLocation.longitude = lon;
        wwd.redraw();
      }
      requestAnimationFrame(joystickLoop);
    }
    requestAnimationFrame(joystickLoop);
  </script>
</body>
</html>
